<link rel="import" href="../tangere/tangere.html">
<link rel="import" href="../iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../at-theme/at-theme.html">
<link rel="import" href="../at-core-splitter/at-core-splitter.html">
<link rel="import" href="../at-core-propform/at-core-propform.html">

<dom-module id="at-doc-demo">
  <style>
    .container {
      margin: 32px;
    }

    #insertPoint {
      margin: 0 13px;
    }

    .content-wrapper {
      width: 50%;
    }
  </style>
  <template>
    <div class="container horizontal layout">
      <div class="flex">
        <at-core-propform id="coreForm" hide="{{hide}}" title-mode="propertyName"></at-core-propform>
      </div>
      <at-core-splitter id="atSplitter" direction="right"></at-core-splitter>
      <div class="vertical layout content-wrapper">
        <div id="insertPoint"></div>
      </div>
    </div>
  </template>
  <script>
    'use strict';
    Polymer({
      is: 'at-doc-demo',
      properties: {
        url: {
          type: String,
          value: '',
          observer: 'urlChanged'
        },
        auto: {
          type: Boolean,
          value: false
        },
        hide: {
          type: Boolean,
          value: false,
          observer: 'hideChanged'
        }
      },
      lastElementName: '',
      attached: function () {
        var bodyHeight = document.body.getBoundingClientRect().height;
        var atSplitter = this.$.atSplitter;
        atSplitter.style['min-height'] = (bodyHeight-300) + 'px';
      },
      ready: function() {

        if (this.auto && this.url === '') {
          // autogenerate the url
          var url = window.location.href;
          var urlParts = url.split("/");
          if (urlParts.length > 2) {
            var componentName = urlParts[urlParts.length - 2];
            var newUrl = componentName + '.html';
            this.url = newUrl;
          }
        }

        var coreForm = this.$.coreForm.$.propForm;
        coreForm.addEventListener('rendered', function(event) {
          coreForm.updateFormElementData('hide', false);
        });
      },
      resetResizeSensor: function() {
        var coreForm = this.$.coreForm;
        coreForm.resetResizeSensor();
      },
      urlChanged: function(newValue, oldValue) {
        var insertPoint = this.$.insertPoint;
        var coreForm = this.$.coreForm;
        var elementName = '';
        // determine element name
        if (this.url.indexOf('/') === -1) {
          // url is of format at-*-*.html
          // strip .html
          elementName = this.url.replace('.html', '');
        } else {
          // url is of format ../at-*-*/at-*-*.html
          // split for '/'
          var parts = this.url.split('/');
          var part = parts[1];
          elementName = part;
        }
        if (newValue !== '') {
          var alreadyImported = Polymer.telemetry.registrations.find(function (element, index) {
            return element.is === elementName;
          });
          if (!alreadyImported) {
            this.importHref(this.url, function(event) {
              // import successful
              this.lastElementName = elementName;
              var element = document.createElement(elementName);
              element.hide = true;
              Polymer.dom(insertPoint).appendChild(element);

              coreForm.elementInstance = element;
            }, function(event) {
              // failure
            }, true);
          } else {
            var element = document.createElement(elementName);
            element.hide = true;
            Polymer.dom(insertPoint).appendChild(element);

            coreForm.elementInstance = element;
          }
        }
      },
      hideChanged: function (newValue, oldValue) {
        var insertPoint =  this.$.insertPoint;
        if (this.lastElementName) {
          var element = Polymer.dom(insertPoint).querySelector(this.lastElementName);
          if (element.properties.hide !== undefined) {
            element.hide = newValue;
            this.$.coreForm.updateFormElementData('hide', false);
          }
        }
      }
    });
  </script>
</dom-module>
