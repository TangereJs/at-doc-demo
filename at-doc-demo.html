<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../at-core-theme/at-core-theme.html">
<link rel="import" href="../at-core-form/at-core-form.html">

<dom-module id="at-doc-demo">
  <style>
    .container {
      margin: 5% 10%;
    }
  </style>
  <template>
    <div class="horizontal layout container">
      <div class="vertical layout flex-6">
        <at-core-form id="coreForm"></at-core-form>
      </div>
      <div id="insertPoint" class="vertical layout flex-6">

      </div>
    </div>
  </template>
  <script>
    'use strict';
    Polymer({
      is: 'at-doc-demo',
      properties: {
        url: {
          type: String,
          value: '',
          observer: 'urlChanged'
        },
        auto: {
          type: Boolean,
          value: false
        }
      },
      _scopeCssViaAttr: true,
      ready: function() {

        if (this.auto && this.url === '') {
          // autogenerate the url
          var url = window.location.href;
          var urlParts = url.split("/");
          if (urlParts.length > 2) {
            var componentName = urlParts[urlParts.length - 2];
            var newUrl = componentName + '.html';
            this.url = newUrl;
          }
        }
      },
      urlChanged: function(newValue, oldValue) {
        var insertPoint = this.$.insertPoint;
        var coreForm = this.$.coreForm;
        if (newValue !== '') {
          this.importHref(this.url, function(event) {
            // import successful
            var importedContent = event.target.import;
            var domModule = importedContent.querySelector('dom-module');
            var elementName = domModule.getAttribute('id');
            var element = document.createElement(elementName);
            Polymer.dom(insertPoint).appendChild(element);
            // generate jsonSchema from properties
            var
              properties = element.properties,
              propertyNames = Object.keys(properties),
              propDef,
              schema = {
                title: elementName,
                description: 'Demo form for ' + elementName,
                properties: {}
              },
              propSchemaDef = {};

            propertyNames.forEach(function(propName, index) {
              propDef = properties[propName];
              propSchemaDef = window.schemaHelpers.convertPolymerElementPropertyToAtCoreFormSchema(propName, propDef);
              schema.properties[propName] = propSchemaDef;
            });
            coreForm.schema = schema;

            coreForm.removeEventListener('data-changed', _data_changed);
            coreForm.addEventListener('data-changed', _data_changed);

            function _data_changed(event) {
              var value = event.detail.value;
              var propertyNames = Object.keys(value)
              schemaHelpers.copyProperties(propertyNames, [], value, element);
            }

            element.addEventListener('value-changed', function(event) {
              var newValue = event.detail.value;
              coreForm.updateFormElementData('value', newValue);
            });

            element.addEventListener('valid-changed', function(event) {
              var newValue = event.detail.value;
              coreForm.updateFormElementData('valid', newValue);
            });

          }, function(event) {
            // failure
          });
        }
      }
    });
  </script>
</dom-module>
